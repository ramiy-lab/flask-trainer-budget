{% extends "base.html" %}

{% block title %}Meal Form | Trainer Budget{% endblock %}

{% block content %}
<section class="card">
  <h2 class="card-title">1食の食材を選ぶ</h2>

  <form method="post" id="meal-form" class="form">

    <!-- 食事タイミング -->
    <div class="form-row">
      <label for="timing-select">食事タイミング</label>
      <select id="timing-select" name="timing" required>
        <option value="">選択してください</option>
        {% for timing, label in MEAL_TIMING_LABELS.items() %}
          <option value="{{ timing }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- フェーズ -->
    <div class="form-row">
      <label for="phase-select">フェーズ</label>
      <select id="phase-select" name="phase" required>
        <option value="">選択してください</option>
        <option value="bulk">増量（Bulk）</option>
        <option value="cut">減量（Cut）</option>
      </select>
    </div>

    <!-- カテゴリ選択 -->
    <div class="form-row">
      <label for="category-select">カテゴリ</label>
      <select id="category-select" class="category-select">
        <option value="">カテゴリを選択</option>
      </select>
    </div>

    <!-- 食材一覧 -->
    <div class="food-grid" id="food-grid">
      {% for food in foods %}
        {% set grams = amounts[food.id] if amounts and food.id in amounts else 100 %}
        <div
          class="food-item"
          data-category="{{ food.category }}"
        >
          <label class="food-select">
            <input
              type="checkbox"
              name="food_ids"
              value="{{ food.id }}"
              class="food-checkbox"
              {% if food.id in selected_ids %}checked{% endif %}
            />
            <span class="food-name">{{ food.name }}</span>
          </label>

          <div class="food-meta">
            <span class="unit-note">（100gあたり）</span>
            <span class="nutrients">
              P {{ "%.1f"|format(food.protein_g) }}g /
              F {{ "%.1f"|format(food.fat_g) }}g /
              C {{ "%.1f"|format(food.carb_g) }}g
            </span>
          </div>

          <div class="food-meta">
            {{ "%.0f"|format(food.kcal) }} kcal /
            ¥{{ food.price }}
          </div>

          <div class="amount-control">
            <label>
              量：
              <input
                type="range"
                min="0"
                max="500"
                step="10"
                value="{{ grams }}"
                class="amount-range"
                data-food-id="{{ food.id }}"
              />
              <span class="amount-value">{{ grams }}</span> g
            </label>
          </div>

          <input
            type="hidden"
            name="food_amounts[{{ food.id }}]"
            value="{{ grams }}"
            class="amount-hidden"
            data-food-id="{{ food.id }}"
          />
        </div>
      {% endfor %}
    </div>

    <!-- リアルタイム集計 -->
    <div class="summary card-inner">
      <h3 class="summary-title">リアルタイム合計</h3>

      <ul id="selected-items" class="selected-items"></ul>

      <div class="summary-grid">
        <div>Protein: <span id="sum-protein">0.0</span> g</div>
        <div>Fat: <span id="sum-fat">0.0</span> g</div>
        <div>Carb: <span id="sum-carb">0.0</span> g</div>
        <div>Kcal: <span id="sum-kcal">0.0</span> kcal</div>
        <div>Price: ¥<span id="sum-price">0</span></div>
      </div>
    </div>

    <button type="submit" class="btn">PFC値と価格を確定</button>
  </form>
</section>

<section class="card">
  <h2 class="card-title">確定結果（サーバー計算）</h2>

  {% if result %}
    <ul class="result-list">
      {% for item in result["items"] %}
        <li>{{ item.food.name }}：{{ item.grams }} g</li>
      {% endfor %}
    </ul>

    <ul class="result-list">
      <li>Protein: {{ "%.1f"|format(result.protein_g) }} g</li>
      <li>Fat: {{ "%.1f"|format(result.fat_g) }} g</li>
      <li>Carb: {{ "%.1f"|format(result.carb_g) }} g</li>
      <li>Kcal: {{ "%.1f"|format(result.kcal) }} kcal</li>
      <li>Price: ¥{{ result.price }}</li>
    </ul>
  {% else %}
    <p class="muted">まだ確定していません。</p>
  {% endif %}
</section>

<script id="foods-json" type="application/json">
  {{ foods | tojson }}
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/meal.js') }}"></script>
{% endblock %}
