{% extends "base.html" %}

{% block title %}Meal Form | Trainer Budget{% endblock %}

{% block content %}
<section class="card">
  <h2 class="card-title">1食の食材を選ぶ</h2>

  <form method="post" id="meal-form" class="form">
    <div class="food-grid">
      {% for food in foods %}
        <div class="food-item">
          <label class="food-select">
            <input
              type="checkbox"
              name="food_ids"
              value="{{ food.id }}"
              class="food-checkbox"
              {% if food.id in selected_ids %}checked{% endif %}
            />
            <span class="food-name">{{ food.name }}</span>
          </label>

          <div class="food-meta">
            <span class="unit-note">（100gあたり）</span>
            <span class="nutrients">
              P {{ "%.1f"|format(food.protein_g) }}g /
              F {{ "%.1f"|format(food.fat_g) }}g /
              C {{ "%.1f"|format(food.carb_g) }}g
            </span>
          </div>


          <div class="food-meta">
            {{ "%.0f"|format(food.kcal) }} kcal /
            ¥{{ food.price }}
          </div>

          <!-- 量選択（10g刻み） -->
          <div class="amount-control">
            <label>
              量：
              <input
                type="range"
                min="0"
                max="500"
                step="10"
                value="100"
                class="amount-range"
                data-food-id="{{ food.id }}"
              />
              <span class="amount-value">100</span> g
            </label>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="summary card-inner">
      <h3 class="summary-title">合計</h3>
      <div class="summary-grid">
        <div>Protein: <span id="sum-protein">0.0</span> g</div>
        <div>Fat: <span id="sum-fat">0.0</span> g</div>
        <div>Carb: <span id="sum-carb">0.0</span> g</div>
        <div>Kcal: <span id="sum-kcal">0.0</span> kcal</div>
        <div>Price: ¥<span id="sum-price">0</span></div>
      </div>
    </div>

    <button type="submit" class="btn">PFC値と価格を確認</button>
  </form>
</section>

<section class="card">
  <h2 class="card-title">確定結果 (サーバー計算)</h2>

  {% if result is none %}
    <p class="muted">
      まだ確定していません。食材を選んで「PFC値と価格を確認」を押してね
    </p>
  {% else %}
    <ul class="result-list">
      <li>Protein: {{ "%.1f"|format(result.protein_g) }} g</li>
      <li>Fat: {{ "%.1f"|format(result.fat_g) }} g</li>
      <li>Carb: {{ "%.1f"|format(result.carb_g) }} g</li>
      <li>Kcal: {{ "%.1f"|format(result.kcal) }} kcal</li>
      <li>Price: ¥{{ result.price }}</li>
    </ul>
  {% endif %}
</section>

{# JS用のfoodsデータ (単一ソース) #}
<script id="foods-json" type="application/json">
  {{ foods | tojson }}
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/meal.js') }}"></script>
{% endblock %}
